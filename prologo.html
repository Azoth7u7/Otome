<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pr√≥logo - El Jard√≠n de las Rosas y las Espinas</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Lato:wght@300;400&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            height: 100vh; width: 100vw; 
            background: #000; 
            font-family: 'Cormorant Garamond', serif; 
            overflow: hidden; 
            user-select: none; -webkit-user-select: none;
            display: flex; justify-content: center; align-items: center; 
        }
        
        /* --- 1. FONDO Y AMBIENTE --- */
        .bg-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; overflow: hidden; }
        #bg-image { width: 100%; height: 100%; object-fit: cover; transform: scale(1.2); transition: transform 6s ease-out, opacity 2s; }
        #bg-image.zoom-out { transform: scale(1.0); }
        
        .color-grade { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(20, 10, 30, 0.3), rgba(60, 30, 50, 0.2)); mix-blend-mode: overlay; z-index: 2; pointer-events: none; }
        .vignette { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, transparent 50%, #000 130%); z-index: 3; pointer-events: none; }
        
        /* --- 2. PERSONAJE (CENTRADO) --- */
        #char-layer { 
            position: absolute; bottom: 0; width: 100%; height: 100%; 
            z-index: 4; pointer-events: none;
            display: flex; justify-content: center; align-items: flex-end; 
        }
        
        .sprite { 
            height: 90vh; width: auto; max-width: 80vw; 
            position: relative; bottom: -5vh; 
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.5)); 
            transition: opacity 0.5s, transform 0.5s; 
            opacity: 0; 
            /* Estado inicial invisible */
            transform: translateY(20px); 
        }
        
        /* Estado visible */
        .sprite.visible { 
            opacity: 1; 
            transform: translateY(0); 
            transition: opacity 2s ease, transform 2s ease-out; 
        }

        /* --- 3. EFECTOS CINEM√ÅTICOS --- */
        #cinematic-black {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 50; opacity: 1; 
            transition: opacity 3s ease-in-out; pointer-events: none;
        }
        #cinematic-black.fade-out { opacity: 0; }

        /* --- 4. UI (INTERFAZ) --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; transition: opacity 1s; }
        #ui-layer.hidden { opacity: 0; pointer-events: none; }

        .dialogue-box { 
            position: absolute; bottom: 5vh; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 1200px; height: 260px;
            background: linear-gradient(135deg, rgba(10, 5, 10, 0.95), rgba(30, 20, 30, 0.9)); 
            border: 2px solid #8a7a5a; border-radius: 4px; 
            box-shadow: 0 10px 50px rgba(0,0,0,0.9); 
            display: flex; flex-direction: column; padding: 0; 
            opacity: 0; transition: opacity 1s; pointer-events: auto; 
        }
        .dialogue-box.visible { opacity: 1; }
        
        .name-tag { 
            position: absolute; top: -20px; left: 40px; 
            background: #250b15; border: 1px solid #d4af37; color: #d4af37; 
            font-family: 'Cinzel', serif; font-size: 1.4rem; padding: 5px 30px; 
            box-shadow: 3px 3px 10px rgba(0,0,0,0.5); 
        }
        
        .text-content { 
            padding: 50px 60px 20px; color: #e0e0e0; 
            font-size: clamp(1.1rem, 2vw, 1.5rem); /* Texto responsive */
            line-height: 1.5; text-align: left; 
            white-space: pre-wrap; letter-spacing: 0.5px; 
        }

        /* Botones de men√∫ r√°pido */
        .vn-menu {
            position: absolute; bottom: 10px; right: 20px;
            display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;
        }
        .vn-btn {
            background: transparent; border: none;
            color: #8a7a5a; font-family: 'Lato', sans-serif;
            font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; padding: 5px 10px;
            transition: all 0.2s; border-bottom: 1px solid transparent;
        }
        .vn-btn:hover { color: #d4af37; border-bottom: 1px solid #d4af37; text-shadow: 0 0 5px rgba(212, 175, 55, 0.5); }

        .next-indicator { position: absolute; bottom: 40px; right: 30px; font-size: 24px; color: #d4af37; animation: bounce 1s infinite; opacity: 0; }
        .next-indicator.active { opacity: 1; cursor: pointer; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }

        /* --- PANTALLAS Y MODALES --- */
        .overlay-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 100; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            transition: opacity 2s; 
        }
        .overlay-screen.hidden { opacity: 0; pointer-events: none; }
        
        h1 { font-family: 'Cinzel', serif; color: #d4af37; font-size: 3rem; text-transform: uppercase; letter-spacing: 5px; margin-bottom: 20px; text-align: center; }
        .press-start { color: #888; font-family: 'Lato', sans-serif; text-transform: uppercase; letter-spacing: 3px; animation: pulse 2s infinite; cursor: pointer; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

        /* Pantalla Final */
        #end-content { opacity: 0; transition: opacity 2s; text-align: center; }
        #end-content.visible { opacity: 1; }
        .return-btn, .modal-btn {
            margin-top: 30px; padding: 10px 30px;
            background: transparent; border: 1px solid #d4af37; color: #d4af37;
            font-family: 'Cinzel', serif; font-size: 1.2rem; cursor: pointer;
            transition: 0.3s;
        }
        .return-btn:hover, .modal-btn:hover { background: #d4af37; color: #000; box-shadow: 0 0 15px #d4af37; }

        /* Modal de Configuraci√≥n */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: linear-gradient(135deg, #1a1015, #080506);
            border: 1px solid #d4af37; padding: 40px;
            text-align: center; max-width: 400px; width: 90%;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
        }
        .modal-title { font-family: 'Cinzel'; font-size: 1.5rem; color: #d4af37; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }

        /* --- RESPONSIVE / M√ìVIL --- */
        /* Pantalla de advertencia de orientaci√≥n */
        #orientation-warning {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: #d4af37; padding: 20px;
        }
        #orientation-warning h2 { font-family: 'Cinzel'; margin-bottom: 10px; }
        #orientation-warning p { font-family: 'Lato'; color: #888; }
        #orientation-icon { font-size: 3rem; animation: rotatePhone 2s infinite ease-in-out; margin-bottom: 20px; }
        @keyframes rotatePhone { 0%, 10% { transform: rotate(0deg); } 40%, 60% { transform: rotate(90deg); } 90%, 100% { transform: rotate(0deg); } }

        /* Solo mostrar si est√° en vertical y es un dispositivo peque√±o */
        @media screen and (orientation: portrait) and (max-width: 850px) {
            #orientation-warning { display: flex; }
        }

        /* Ajustes para pantallas peque√±as (m√≥viles landscape) */
        @media screen and (max-height: 500px) {
            .dialogue-box { height: 180px; bottom: 2vh; }
            .text-content { padding: 30px 40px 10px; font-size: 1rem; }
            .name-tag { top: -15px; font-size: 1rem; padding: 2px 20px; }
            .sprite { height: 85vh; }
            .vn-menu { bottom: 5px; right: 10px; gap: 5px; }
            .vn-btn { font-size: 0.7rem; padding: 2px 5px; }
        }

    </style>
</head>
<body>

    <div id="orientation-warning">
        <div id="orientation-icon">üì± ‚ûî üì≤</div>
        <h2>Gira tu dispositivo</h2>
        <p>Esta experiencia est√° dise√±ada<br>para jugarse en horizontal.</p>
    </div>

    <div id="start-screen" class="overlay-screen" onclick="startCinematic()">
        <h1>Pr√≥logo</h1>
        <p class="press-start">[ Click para Iniciar ]</p>
    </div>

    <div id="end-screen" class="overlay-screen hidden">
        <div id="end-content">
            <h1>Fin del Pr√≥logo</h1>
            <p style="color: #888; font-family: 'Lato'; margin-bottom: 20px;">Gracias por leer</p>
            <button class="return-btn" onmouseenter="playHover()" onclick="goToIndex()">Volver al Men√∫ Principal</button>
        </div>
    </div>

    <div id="config-modal" class="modal-overlay" onclick="closeConfig()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="modal-title">Pausa</h2>
            <p style="color: #888; font-family: 'Lato'; margin-bottom: 20px;">Juego Pausado</p>
            
            <button class="modal-btn" onclick="closeConfig()">Reanudar</button>
            <br><br>
            <button class="modal-btn" style="border-color: #a33;" onclick="goToIndex()">Salir al Men√∫ Principal</button>
        </div>
    </div>

    <div id="cinematic-black"></div>

    <div class="bg-container">
        <img src="bg.png" id="bg-image" alt="Fondo Academia">
    </div>

    <div class="color-grade"></div>
    <div class="vignette"></div>

    <div id="char-layer">
        <img src="sprite_thinking.png" alt="Marianne" class="sprite" id="marianne-sprite">
    </div>

    <div id="ui-layer">
        <div class="dialogue-box" id="dialogue-box" onclick="nextInteraction()">
            <div class="name-tag">Marianne</div>
            <div class="text-content" id="typewriter-text"></div>
            
            <div class="vn-menu">
                <button class="vn-btn" onmouseenter="playHover()" onclick="playClick(); event.stopPropagation();">Log</button>
                <button class="vn-btn" onmouseenter="playHover()" onclick="playClick(); event.stopPropagation();">Auto</button>
                <button class="vn-btn" onmouseenter="playHover()" onclick="playClick(); event.stopPropagation();">Save</button>
                <button class="vn-btn" onmouseenter="playHover()" onclick="playClick(); event.stopPropagation();">Load</button>
                <button class="vn-btn" onmouseenter="playHover()" onclick="openConfig(); event.stopPropagation();">Config</button>
            </div>

            <div class="next-indicator" id="next-arrow">‚ñº</div>
        </div>
    </div>

    <audio id="voice-player"></audio>
    <audio id="bgm-player" loop></audio>
    <audio id="sfx-footsteps" src="footsteps.mp3"></audio>
    <audio id="sfx-click" src="click.mp3"></audio>
    <audio id="sfx-hover" src="hover.mp3"></audio> 

    <script>
        // CONFIGURACI√ìN DE IM√ÅGENES
        const IMG_NORMAL = "sprite_normal.png";
        const IMG_HAPPY = "sprite_happy.png";
        const IMG_SCARED = "sprite_scared.png";
        const IMG_THINKING = "sprite_thinking.png";

        // GUI√ìN
        const script = [
            { text: "... Al fin estoy aqu√≠. La Real Academia.", audioSrc: "1.mp3", expression: IMG_THINKING, duration: 5 },
            { text: "Supongo que lo correcto ser√≠a presentarme. Soy Marianne von Eidehart. Y aunque hoy porto este apellido con orgullo... no siempre fue mi nombre.", audioSrc: "2.mp3", expression: IMG_NORMAL, duration: 15 },
            { text: "Mis primeros a√±os transcurrieron en un orfanato de un pa√≠s extranjero. No guardo una pizca de tristeza de aquel entonces, pero s√≠ el recuerdo n√≠tido del d√≠a en que mi mundo dio un vuelco.", audioSrc: "3.mp3", expression: IMG_NORMAL, duration: 14 },
            { text: "Un carruaje con un emblema desconocido se detuvo ante nuestra puerta. El duque Eidehart, que estaba en el pa√≠s por negocios, hab√≠a decidido hacer una parada en la iglesia... y termin√≥ llev√°ndose a una ni√±a de cinco a√±os consigo.", audioSrc: "4.mp3", expression: IMG_NORMAL, duration: 15 },
            { text: "O sea, a m√≠. Jejeje.", audioSrc: "5.mp3", expression: IMG_HAPPY, duration: 4 },
            { text: "Fue as√≠ como la mansi√≥n Eidehart se convirti√≥ en mi nuevo hogar. Sus hijos, Friedrich y Liliane, pasaron a ser mis hermanos de la noche a la ma√±ana.", audioSrc: "6.mp3", expression: IMG_NORMAL, duration: 14 },
            { text: "Friedrich es el mayor. De ni√±os me daba un poco de cosa acercarme a √©l; siempre estaba con la nariz metida en un libro o entrenando con la espada. Era, b√°sicamente, un ni√±o destinado a ser el heredero perfecto.", audioSrc: "7.mp3", expression: IMG_THINKING, duration: 16 },
            { text: "Pero bueno, despu√©s de un tiempo te das cuenta de c√≥mo es. Es un tipo serio y de pocas palabras, s√≠, pero es de los que te cuida las espaldas sin que te enteres. A su manera, supongo.", audioSrc: "8.mp3", expression: IMG_HAPPY, duration: 17 },
            { text: "Jam√°s olvidar√© la vez que me perd√≠ en los jardines. Me busc√≥ durante horas sin decirle nada a nadie, solo para evitar que me castigaran.", audioSrc: "9.mp3", expression: IMG_NORMAL, duration: 11 },
            { text: "Friedrich nunca te va a decir un ¬´te quiero¬ª, pero lo demuestra todo el tiempo con lo que hace.", audioSrc: "10.mp3", expression: IMG_NORMAL, duration: 10 },
            { text: "Y luego estaba Liliane. Mi hermana. La verdad es que explicar nuestro v√≠nculo es... bueno, bastante complejo. Jeje...", audioSrc: "11.mp3", expression: IMG_SCARED, duration: 14 },
            { text: "Crecimos en la misma casa, pero era como si vivi√©ramos en planetas diferentes. No es que nos llev√°ramos mal o nos pele√°ramos a gritos; es m√°s bien como un muro que siempre ha estado ah√≠ y no tengo ni idea de c√≥mo romper.", audioSrc: "12.mp3", expression: IMG_SCARED, duration: 14 },
            { text: "A veces siento que solo por estar en la misma habitaci√≥n que ella, ya la estoy molestando. Y lo peor es que, por m√°s que lo pienso, no entiendo qu√© es lo que hice mal.", audioSrc: "13.mp3", expression: IMG_SCARED, duration: 12 },
            { text: "Pero bueno, al final del d√≠a es mi familia. Y me gusta pensar que, muy en el fondo, s√≠ que me quiere un poco. A su manera, supongo.", audioSrc: "14.mp3", expression: IMG_NORMAL, duration: 14 },
            { text: "¬°Ah...! La ceremonia de apertura debe de estar por empezar. Todos, desde los veteranos hasta los novatos como yo, tenemos que reunirnos en el gran sal√≥n.", audioSrc: "15.mp3", expression: IMG_NORMAL, duration: 10 },
            { text: "Este a√±o va a ser diferente. Ya no soy solo la ni√±a que correteaba por los jardines del duque; ahora soy una estudiante m√°s, con mi propio camino por delante.", audioSrc: "16.mp3", expression: IMG_THINKING, duration: 13 },
            { text: "Conocer√© gente nueva, har√© amigas... o qui√©n sabe, quiz√°s algo m√°s. Jeje.", audioSrc: "17.mp3", expression: IMG_HAPPY, duration: 10 },
            { text: "No tengo ni idea de lo que me espera en la academia, pero quiero aprovecharlo al m√°ximo. No quiero quedarme con ganas de nada.", audioSrc: "18.mp3", expression: IMG_NORMAL, duration: 9 },
            { text: "En fin... ¬°es hora de ponerse en marcha!", audioSrc: "19.mp3", expression: IMG_HAPPY, duration: 2 }
        ];

        // VARIABLES DE ESTADO
        let currentIndex = 0;
        let isTyping = false;
        let isPlayingAudio = false;
        let gameStarted = false;
        let typeInterval;
        let fadeInterval;

        // ELEMENTOS DOM
        const uiText = document.getElementById('typewriter-text');
        const sprite = document.getElementById('marianne-sprite');
        const nextArrow = document.getElementById('next-arrow');
        const dialogueBox = document.getElementById('dialogue-box');
        const bgImage = document.getElementById('bg-image');
        const cinematicBlack = document.getElementById('cinematic-black');
        const endScreen = document.getElementById('end-screen');
        const endContent = document.getElementById('end-content');
        
        // REPRODUCTORES
        const voicePlayer = document.getElementById('voice-player');
        const bgmPlayer = document.getElementById('bgm-player');
        const footstepsPlayer = document.getElementById('sfx-footsteps');
        const clickPlayer = document.getElementById('sfx-click');
        const hoverPlayer = document.getElementById('sfx-hover');

        // --- FUNCIONES DE SONIDO UI ---
        function playHover() {
            if(hoverPlayer) {
                hoverPlayer.currentTime = 0;
                hoverPlayer.volume = 0.5;
                hoverPlayer.play().catch(()=>{});
            }
        }

        function playClick() {
            if(clickPlayer) {
                clickPlayer.currentTime = 0;
                clickPlayer.play().catch(()=>{});
            }
        }

        // --- FUNCI√ìN CORREGIDA: VOLVER AL INDEX ---
        function goToIndex() {
            playClick();
            // Desvanecer a negro antes de irse
            document.body.style.transition = "opacity 1s";
            document.body.style.opacity = 0;
            
            setTimeout(() => {
                window.location.href = "index.html"; 
            }, 1000);
        }

        // --- FUNCIONES DE CONFIGURACI√ìN ---
        function openConfig() {
            playClick();
            document.getElementById('config-modal').classList.add('visible');
        }

        function closeConfig() {
            playClick();
            document.getElementById('config-modal').classList.remove('visible');
        }

        // --- SISTEMA DE JUEGO ---

        function startCinematic() {
            if (gameStarted) return;
            gameStarted = true;
            playClick();
            document.getElementById('start-screen').classList.add('hidden');

            // 1. PASOS EN LA OSCURIDAD (4 SEGUNDOS)
            footstepsPlayer.volume = 0.8;
            footstepsPlayer.play().catch(e => console.log("Error audio pasos"));

            // 2. DESPU√âS DE 4 SEGUNDOS, SE HACE LA LUZ
            setTimeout(() => {
                cinematicBlack.classList.add('fade-out');
                bgImage.classList.add('zoom-out');
                sprite.classList.add('visible');
                
                bgmPlayer.src = "theme_piano.mp3";
                bgmPlayer.volume = 0.4;
                bgmPlayer.play();

            }, 4000);

            // 3. INICIO DI√ÅLOGO
            setTimeout(() => {
                dialogueBox.classList.add('visible');
                playNode(0);
            }, 6000);
        }

        function nextInteraction() {
            if (!gameStarted) return;
            
            // Si el modal de config est√° abierto, no avanzar
            if (document.getElementById('config-modal').classList.contains('visible')) return;

            playClick();

            if (isTyping) {
                clearInterval(typeInterval);
                uiText.textContent = script[currentIndex].text;
                isTyping = false;
                checkFinish();
                return;
            }

            if (isPlayingAudio) return; 

            currentIndex++;
            if (currentIndex < script.length) {
                playNode(currentIndex);
            } else {
                finishGame();
            }
        }

        function finishGame() {
            // OCULTAR UI
            document.getElementById('ui-layer').style.opacity = 0;
            
            // FADE A NEGRO LENTO
            cinematicBlack.classList.remove('fade-out'); 
            
            // BAJAR M√öSICA LENTAMENTE
            let vol = bgmPlayer.volume;
            let musicFade = setInterval(() => {
                if(vol > 0.02) {
                    vol -= 0.02;
                    bgmPlayer.volume = vol;
                } else {
                    bgmPlayer.pause();
                    clearInterval(musicFade);
                }
            }, 100);

            // MOSTRAR PANTALLA FINAL
            setTimeout(() => {
                endScreen.classList.remove('hidden');
                setTimeout(() => {
                    endContent.classList.add('visible');
                }, 500);
            }, 3000);
        }

        function playNode(index) {
            const data = script[index];
            
            uiText.textContent = "";
            nextArrow.classList.remove('active');
            isTyping = true;
            isPlayingAudio = true;

            // Cambiar Sprite (si es diferente)
            if (!sprite.src.includes(data.expression)) {
                sprite.style.opacity = 0;
                setTimeout(() => {
                    sprite.src = data.expression;
                    sprite.style.opacity = 1;
                }, 200);
            }

            voicePlayer.src = data.audioSrc;
            voicePlayer.volume = 1.0;
            
            voicePlayer.onplay = () => {
                fadeMusic(0.1); 
                startTypewriter(data.text, data.duration);
            };

            voicePlayer.onended = () => {
                isPlayingAudio = false;
                fadeMusic(0.4); 
                checkFinish();
            };

            voicePlayer.play().catch(e => {
                startTypewriter(data.text, 3);
                isPlayingAudio = false;
            });
        }

        function startTypewriter(text, durationSec) {
            if (typeInterval) clearInterval(typeInterval);
            
            const totalChars = text.length;
            const durationMs = (durationSec * 1000) - 200;
            let charSpeed = durationMs / totalChars;
            if (charSpeed < 10) charSpeed = 10;

            let i = 0;
            typeInterval = setInterval(() => {
                uiText.textContent += text.charAt(i);
                i++;
                if (i >= totalChars) {
                    clearInterval(typeInterval);
                    isTyping = false;
                    checkFinish();
                }
            }, charSpeed);
        }

        function checkFinish() {
            if (!isTyping && !isPlayingAudio) {
                nextArrow.classList.add('active');
            }
        }

        function fadeMusic(targetVol) {
            if (fadeInterval) clearInterval(fadeInterval);
            fadeInterval = setInterval(() => {
                let current = bgmPlayer.volume;
                if (Math.abs(current - targetVol) < 0.02) {
                    bgmPlayer.volume = targetVol;
                    clearInterval(fadeInterval);
                } else if (current > targetVol) {
                    bgmPlayer.volume -= 0.02;
                } else {
                    bgmPlayer.volume += 0.02;
                }
            }, 50);
        }

    </script>
</body>
</html>